import{program as d}from"commander";import L from"node:fs";import{fileURLToPath as Z}from"node:url";import{dirname as q,resolve as R}from"node:path";function a(){let e=R(q(Z(import.meta.url)),"config.json");return JSON.parse(L.readFileSync(e,{encoding:"utf-8"}))}import M from"inquirer";import W from"node:fs";import{fileURLToPath as _}from"node:url";import{dirname as J,resolve as K}from"node:path";function p(e){let t=K(J(_(import.meta.url)),"config.json");W.writeFileSync(t,JSON.stringify(e))}import B from"cli-table3";function m(e){let t=new B({chars:{top:"\u2550","top-mid":"\u2564","top-left":"\u2554","top-right":"\u2557",bottom:"\u2550","bottom-mid":"\u2567","bottom-left":"\u255A","bottom-right":"\u255D",left:"\u2551","left-mid":"\u255F",mid:"\u2500","mid-mid":"\u253C",right:"\u2551","right-mid":"\u2562",middle:"\u2502"},style:{"padding-left":0,"padding-right":0},colWidths:[15,15,15,15,15,15,15,15,15],wordWrap:!0});t.push([{content:"\u9879\u76EE\u4FE1\u606F",colSpan:2,hAlign:"center"},{content:"\u670D\u52A1\u5668\u4FE1\u606F",colSpan:4,hAlign:"center"},{content:"\u9879\u76EE\u8BE6\u7EC6\u4FE1\u606F",colSpan:3,hAlign:"center"}],[{content:"\u9879\u76EE\u540D\u79F0",hAlign:"center"},{content:"value",hAlign:"center"},{content:"SSH\u5730\u5740",hAlign:"center"},{content:"SSH\u7AEF\u53E3",hAlign:"center"},{content:"SSH\u7528\u6237\u540D",hAlign:"center"},{content:"SSH\u5BC6\u7801",hAlign:"center"},{content:"\u6253\u5305\u6587\u4EF6\u5939",hAlign:"center"},{content:"\u8FDC\u7A0B\u76EE\u5F55",hAlign:"center"},{content:"\u8FDC\u7A0B\u6587\u4EF6\u5939",hAlign:"center"}]),t.push(...e.map(o=>[{content:o.name,hAlign:"center"},{content:o.value,hAlign:"center"},{content:o.ssh.host,hAlign:"center"},{content:o.ssh.port,hAlign:"center"},{content:o.ssh.username,hAlign:"center"},{content:"********",hAlign:"center"},{content:o.targetDir,hAlign:"center"},{content:o.deployDir,hAlign:"center"},{content:o.releaseDir,hAlign:"center"}])),console.log(t.toString())}import V from"chalk";async function x(){let e=a(),t=await M.prompt([{type:"input",name:"name",message:"\u8BF7\u8F93\u5165\u9879\u76EE\u540D\u79F0(Project name)",validate:function(r){return/^[a-zA-Z0-9]+$/.test(r)?!0:e.find(n=>n.name===r)?"\u9879\u76EE\u5DF2\u5B58\u5728(project already exists)":"\u8BF7\u8F93\u5165\u82F1\u6587\u5B57\u7B26(enter English characters)"}},{type:"input",name:"host",message:"\u8BF7\u8F93\u5165SSH\u5730\u5740(SSH address)",validate(r,n){return r?!0:"\u8BF7\u8F93\u5165SSH\u5730\u5740"}},{type:"input",name:"port",message:"\u8BF7\u8F93\u5165SSH\u7AEF\u53E3(\u9ED8\u8BA422)(SSH Port default is 22)"},{type:"input",name:"username",message:"\u8BF7\u8F93\u5165\u670D\u52A1\u5668\u7528\u6237\u540D(\u9ED8\u8BA4root)(User name default is root)"},{type:"password",name:"password",message:"\u8BF7\u8F93\u5165\u670D\u52A1\u5668\u5BC6\u7801(SSH Password)",mask:"*",validate(r,n){return r?!0:"\u8BF7\u8F93\u5165\u670D\u52A1\u5668\u5BC6\u7801"}},{type:"input",name:"targetDir",message:"\u672C\u5730\u9879\u76EE\u6587\u4EF6\u5939(\u4F8B:C:\\project)(The folder where the package file is located)",validate(r,n){return r?!0:"\u672C\u5730\u9879\u76EE\u6253\u5305\u6587\u4EF6\u5939(The folder where the package file is located)"},filter(r,n){return r.replace(/\\/g,"/")}},{type:"input",name:"deployDir",message:"\u8FDC\u7A0B\u90E8\u7F72\u76EE\u5F55(\u4F8B:/home/www/)(The deployment directory on the server)",validate(r,n){return r?!0:"\u8FDC\u7A0B\u90E8\u7F72\u76EE\u5F55(\u4F8B:/home/www/)(The deployment directory on the server)"},filter(r,n){return r.replace(/\\/g,"/")}},{type:"input",name:"releaseDir",message:"\u8FDC\u7A0B\u90E8\u7F72\u6587\u4EF6\u5939(The folder where the deployment package is located)"}]),o={value:t.name,ssh:{host:t.host,password:t.password,username:t.username||"root",port:t.port?Number(t.port):22},releaseDir:t.releaseDir||t.name,name:t.name,targetDir:t.targetDir,deployDir:t.deployDir};e.push(o),p(e),console.log(V.green("\u6DFB\u52A0\u6210\u529F")),m([o])}import G from"inquirer";import Q from"chalk";async function y(e){let t=a();if(t.find(r=>r.name===e))m([t.find(r=>r.name===e)]);else{console.log(Q.red(`scd \u{1F975} ${e}\u914D\u7F6E\u4E0D\u5B58\u5728`));return}if((await G.prompt({type:"confirm",name:"confirm",message:`\u662F\u5426\u786E\u8BA4\u5220\u9664 ${e} ?`})).confirm){let r=t.splice(t.findIndex(n=>n.name===e),1);p(t),console.log(`\u5DF2\u5220\u9664 ${e} `)}}import C from"chalk";var $=()=>{let e=a();e.length||(console.log(C.red("scd \u{1F9D0} \u65E0\u914D\u7F6E\u9879,\u8BF7\u8FD0\u884Cscd add\u53BB\u6DFB\u52A0\u4E00\u4E2A\u5427")),process.exit(0)),m(e)},z=e=>{let t=a();t.length||(console.log(C.red("scd \u{1F9D0} \u65E0\u914D\u7F6E\u9879,\u8BF7\u8FD0\u884Cscd add\u53BB\u6DFB\u52A0\u4E00\u4E2A\u5427")),process.exit(1));let o=t.filter(r=>r.name===e);console.log(o),o.length?m(o):console.log(C.red(`scd \u{1F975} ${e}\u914D\u7F6E\u4E0D\u5B58\u5728`))};import E from"chalk";import{exec as X}from"child_process";function v(e,t){return new Promise((o,r)=>{X(t,{cwd:e}).on("exit",o).on("error",r)})}import H from"node:path";import h from"chalk";import Y from"archiver";import b from"node:fs";import T from"node:path";import u from"chalk";function F(e,t){return console.log(u.blue("ZIP \u23F3 \u6B63\u5728\u538B\u7F29\u6587\u4EF6...")),new Promise((o,r)=>{let n=b.createWriteStream(T.resolve(e,"dist.zip")),l=Y("zip",{zlib:{level:9}});l.pipe(n),l.directory(T.resolve(e,"dist"),t),l.finalize(),n.on("close",()=>{u.green("ZIP \u538B\u7F29\u5B8C\u6210"),u.green(console.log(`${u.green("SAVE \u{1F4BE} "+(l.pointer()/1024/1024).toFixed(2)+"MB")}\u5B57\u8282\u7684\u6570\u636E\u5DF2\u88AB\u5199\u5165\uFF1A${u.blue(e)}`)),o()}),n.on("error",r)})}import f from"chalk";import{NodeSSH as j}from"node-ssh";var g=new j;function ee(e){return new Promise(async(t,o)=>{g.connect(e.ssh).then(r=>{console.log(f.green(`${e.name} \u{1F605} \u670D\u52A1\u5668\u8FDE\u63A5\u6210\u529F`)),t(r)}).catch(r=>{console.log(f.red(`${e.name} \u{1F605} \u670D\u52A1\u5668\u8FDE\u63A5\u5931\u8D25`)),process.exit(0)})})}function re(e){return new Promise((t,o)=>{g.execCommand(`ls ${e}`).then(r=>{r.stderr?t(!0):t(!1)}).catch(r=>{console.log(f.red("SSH \u{1F605} \u670D\u52A1\u5668\u8FDE\u63A5\u4E2D\u65AD"))})})}function te(e){return new Promise((t,o)=>{g.execCommand(`rm -rf ${e}`).then(r=>{r.stderr?(t(r.stderr),process.exit(0)):t(!0)})})}function oe(e,t){return new Promise((o,r)=>{g.putFile(e,t+"/dist.zip").then(n=>{console.log(f.green("SSH \u{1F4C2} \u6587\u4EF6\u4E0A\u4F20\u6210\u529F")),o(!0)}).catch(n=>{console.log(f.red("SSH \u{1F975} \u6587\u4EF6\u4E0A\u4F20\u5931\u8D25")),r(!1)})})}function ne(e,t){return new Promise((o,r)=>{g.execCommand("unzip dist.zip",{cwd:e}).then(n=>{console.log(f.green("SSH \u{1F4C2} \u6587\u4EF6\u89E3\u538B\u6210\u529F")),o(!0)}).catch(n=>{console.log(f.red("SSH \u{1F605} \u670D\u52A1\u5668\u8FDE\u63A5\u4E2D\u65AD")),r(!1)})})}var c={connect:ee,ssh:g,checkFile:re,deleteFile:te,putFile:oe,unZip:ne};import ie from"node:fs";async function k(e){try{console.log(h.blue(`${e.name} \u23F3 \u5F00\u59CB\u6253\u5305`)),await v(H.resolve(e.targetDir),"npm run build"),console.log(h.green(`${e.name} \u2714 \u6253\u5305\u5B8C\u6210`))}catch{console.log(h.red(`${e.name} \u2718 \u6253\u5305\u5931\u8D25`))}await F(e.targetDir,e.releaseDir),await c.connect(e),await c.checkFile(e.deployDir+"/dist.zip")||await c.deleteFile(e.deployDir+"/dist"),await c.putFile(H.resolve(e.targetDir,"./dist.zip"),e.deployDir);let o=await c.checkFile(e.deployDir+e.releaseDir);await c.deleteFile(e.deployDir+e.releaseDir),await c.unZip(e.deployDir,e.releaseDir)&&console.log(h.green(`${e.name} \u2728 \u90E8\u7F72\u5B8C\u6210`)),await ie.unlinkSync(H.resolve(e.targetDir,"./dist.zip")),await c.deleteFile(e.deployDir+"dist.zip")&&console.log(h.green(`${e.name} \u2728 \u4E34\u65F6\u6587\u4EF6\u6E05\u9664\u6210\u529F`)),c.ssh.dispose()}import se from"inquirer";import ae from"chalk";async function w(e){let t=a();t.length||(console.log(ae.red("scd \u{1F9D0} \u65E0\u914D\u7F6E\u9879,\u8BF7\u8FD0\u884Cscd add\u53BB\u6DFB\u52A0\u4E00\u4E2A\u5427")),process.exit(0));let o=t.map(r=>r.name);return se.prompt([{type:"list",name:"projectName",message:"\u8BF7\u9009\u62E9\u8981\u64CD\u4F5C\u7684\u9879\u76EE",choices:o,default:1}])}import N from"chalk";import le from"inquirer";async function S(e,t){let o=a();o.length||(console.log(N.red("scd \u{1F937}\u200D\u2642\uFE0F \u65E0\u914D\u7F6E\u9879,\u8BF7\u8FD0\u884Cscd add\u53BB\u6DFB\u52A0\u4E00\u4E2A\u5427")),process.exit(0));let r=a().findIndex(s=>s.name===e);r<0&&(console.log(N.red(`scd \u{1F975} ${e}\u914D\u7F6E\u4E0D\u5B58\u5728`)),process.exit(0));let n=await le.prompt([{type:"input",name:"name",message:"\u8BF7\u8F93\u5165\u9879\u76EE\u540D\u79F0(Project name)",default:o[r].name,validate:function(s){return/^[a-zA-Z0-9]+$/.test(s)?!0:o.find(i=>i.name===s)?"\u9879\u76EE\u5DF2\u5B58\u5728(project already exists)":"\u8BF7\u8F93\u5165\u82F1\u6587\u5B57\u7B26(enter English characters)"}},{type:"input",name:"host",message:"\u8BF7\u8F93\u5165SSH\u5730\u5740(SSH address)",default:o[r].ssh.host,validate(s,i){return s?!0:"\u8BF7\u8F93\u5165SSH\u5730\u5740"}},{type:"input",name:"port",message:"\u8BF7\u8F93\u5165SSH\u7AEF\u53E3(\u9ED8\u8BA422)(SSH Port default is 22)",default:o[r].ssh.port},{type:"input",name:"username",message:"\u8BF7\u8F93\u5165\u670D\u52A1\u5668\u7528\u6237\u540D(\u9ED8\u8BA4root)(User name default is root)",default:o[r].ssh.username},{type:"password",name:"password",message:"\u8BF7\u8F93\u5165\u670D\u52A1\u5668\u5BC6\u7801(SSH Password)",default:o[r].ssh.password,validate(s,i){return s?!0:"\u8BF7\u8F93\u5165\u670D\u52A1\u5668\u5BC6\u7801"}},{type:"input",name:"targetDir",message:"\u672C\u5730\u9879\u76EE\u6253\u5305\u6587\u4EF6\u5939(\u4F8B:C:\\project\\dist)(The folder where the package file is located)",validate(s,i){return s?!0:"\u672C\u5730\u9879\u76EE\u6253\u5305\u6587\u4EF6\u5939(The folder where the package file is located)"},default:o[r].targetDir,filter(s,i){return s.replace(/\\/g,"/")}},{type:"input",name:"deployDir",message:"\u8FDC\u7A0B\u90E8\u7F72\u76EE\u5F55(\u4F8B:/home/www/)(The deployment directory on the server)",validate(s,i){return s?!0:"\u8FDC\u7A0B\u90E8\u7F72\u76EE\u5F55(\u4F8B:/home/www/)(The deployment directory on the server)"},filter(s,i){return s.replace(/\\/g,"/")},default:o[r].deployDir},{type:"input",name:"releaseDir",default:o[r].releaseDir,message:"\u8FDC\u7A0B\u90E8\u7F72\u6587\u4EF6\u5939(The folder where the deployment package is located)"}]),l={value:n.name,ssh:{host:n.host,password:n.password,username:n.username||"root",port:n.port?Number(n.port):22},releaseDir:n.releaseDir||n.name,name:n.name,targetDir:n.targetDir,deployDir:n.deployDir};o[r]=l,p(o)}import O from"chalk";function D(e,t="",o={}){for(let r in e)if(e.hasOwnProperty(r)){let n=t?t+"_"+r:r;typeof e[r]=="object"&&e[r]!==null?D(e[r],n,o):o[n]=e[r]}return o}import ce from"inquirer";var pe={name:"\u8BF7\u8F93\u5165\u9879\u76EE\u540D\u79F0(Project name)",targetDir:"\u672C\u5730\u9879\u76EE\u6253\u5305\u6587\u4EF6\u5939(\u4F8B:C:\\project\\dist)(The folder where the package file is located)",deployDir:"\u8FDC\u7A0B\u90E8\u7F72\u76EE\u5F55(\u4F8B:/home/www/)(The deployment directory on the server)",releaseDir:"\u8FDC\u7A0B\u90E8\u7F72\u6587\u4EF6\u5939(The folder where the deployment package is located)",ssh:"\u8BF7\u8F93\u5165SSH\u5730\u5740(SSH address)",prot:"\u8BF7\u8F93\u5165SSH\u7AEF\u53E3(\u9ED8\u8BA422)(SSH Port default is 22)",username:"\u8BF7\u8F93\u5165\u670D\u52A1\u5668\u7528\u6237\u540D(\u9ED8\u8BA4root)(User name default is root)",password:"\u8BF7\u8F93\u5165\u670D\u52A1\u5668\u5BC6\u7801(SSH Password)",host:"host"};async function A(e,t){let o=a(),r=a().findIndex(n=>n.name===e);if(r<0)console.log(O.red(`scd \u{1F975} ${e}\u914D\u7F6E\u4E0D\u5B58\u5728`)),process.exit(0);else{let n=D(o[r]),l=Object.keys(n),s=l.findIndex(U=>U.split("_").includes(t));s<0&&(console.log(O.red(`scd \u{1F975} ${t}\u914D\u7F6E\u4E0D\u5B58\u5728`)),process.exit(0));let i=l[s].split("_"),I=i[i.length-1],P=await ce.prompt([{type:i[i.length-1]=="password"?"password":"input",name:i[i.length-1],message:pe[I],default:i.length>1?o[r][i[0]][i[1]]:o[r][i[0]]}]);i.length>1?o[r][i[0]][i[1]]=P[i[1]]:o[r][i[0]]=P[i[0]],p(o)}}d.command("add").action(async()=>{await x()}).description("\u6DFB\u52A0\u4E00\u4E2A\u9879\u76EE").alias("a");d.command("remove [name]").action(async e=>{if(e)await y(e);else{let t=await w(e);await y(t.projectName)}}).description("\u5220\u9664\u4E00\u4E2A\u9879\u76EE").alias("rm");d.command("list [name]").action(async e=>{e?(console.log(e,"listOnly"),await z(e)):await $()}).description("\u67E5\u770B\u4E00\u4E2A\u6216\u6240\u6709\u9879\u76EE").alias("ls");d.command("run [name]").action(async e=>{e||(e=(await w(e)).projectName);let t=a();t.length||(console.log(E.red("scd \u{1F9D0} \u65E0\u914D\u7F6E\u9879,\u8BF7\u8FD0\u884Cscd add\u53BB\u6DFB\u52A0\u4E00\u4E2A\u5427")),process.exit(0));let o=t.find(r=>r.name===e);o?await k(o):(console.log(E.red(`scd \u{1F975} ${e}\u914D\u7F6E\u4E0D\u5B58\u5728`)),process.exit(0))}).description("\u8FD0\u884C\u9879\u76EE\u6216\u6307\u5B9A\u4E00\u4E2A\u9879\u76EE").alias("r");d.command("edit [name] [key]").action(async(e,t)=>{!t&&!e&&(e=(await w(e)).projectName,await S(e),process.exit(0)),t&&e?await A(e,t):await S(e,t)}).description("\u7F16\u8F91\u4E00\u4E2A\u9879\u76EE\u6216\u9879\u76EE\u914D\u7F6E").alias("e");d.command("help").action(()=>{d.outputHelp()}).description("\u67E5\u770B\u5E2E\u52A9").alias("h");d.parse(process.argv);
