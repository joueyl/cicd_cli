#!/usr/bin/env node
import{program as m}from"commander";import Q from"node:fs";import{fileURLToPath as X}from"node:url";import{dirname as Y,resolve as j}from"node:path";function a(){let e=j(Y(X(import.meta.url)),"config.json");return JSON.parse(Q.readFileSync(e,{encoding:"utf-8"}))}import ie from"inquirer";import ee from"node:fs";import{fileURLToPath as re}from"node:url";import{dirname as te,resolve as oe}from"node:path";function p(e){let t=oe(te(re(import.meta.url)),"config.json");ee.writeFileSync(t,JSON.stringify(e))}import ne from"cli-table3";function d(e){let t=new ne({chars:{top:"\u2550","top-mid":"\u2564","top-left":"\u2554","top-right":"\u2557",bottom:"\u2550","bottom-mid":"\u2567","bottom-left":"\u255A","bottom-right":"\u255D",left:"\u2551","left-mid":"\u255F",mid:"\u2500","mid-mid":"\u253C",right:"\u2551","right-mid":"\u2562",middle:"\u2502"},style:{"padding-left":0,"padding-right":0},colWidths:[15,15,15,15,15,15,15,15,15],wordWrap:!0});t.push([{content:"\u9879\u76EE\u4FE1\u606F",colSpan:2,hAlign:"center"},{content:"\u670D\u52A1\u5668\u4FE1\u606F",colSpan:5,hAlign:"center"},{content:"\u9879\u76EE\u8BE6\u7EC6\u4FE1\u606F",colSpan:3,hAlign:"center"}],[{content:"\u9879\u76EE\u540D\u79F0",hAlign:"center"},{content:"value",hAlign:"center"},{content:"\u670D\u52A1\u5668\u5730\u5740",hAlign:"center"},{content:"\u670D\u52A1\u5668\u7AEF\u53E3",hAlign:"center"},{content:"\u670D\u52A1\u5668\u7528\u6237\u540D",hAlign:"center"},{content:"\u670D\u52A1\u5668\u5BC6\u7801",hAlign:"center"},{content:"\u670D\u52A1\u5668\u7C7B\u578B",hAlign:"center"},{content:"\u6253\u5305\u6587\u4EF6\u5939",hAlign:"center"},{content:"\u8FDC\u7A0B\u76EE\u5F55",hAlign:"center"},{content:"\u8FDC\u7A0B\u6587\u4EF6\u5939",hAlign:"center"}]),t.push(...e.map(o=>[{content:o.name,hAlign:"center"},{content:o.value,hAlign:"center"},{content:o.server.host,hAlign:"center"},{content:o.server.port,hAlign:"center"},{content:o.server.username,hAlign:"center"},{content:"********",hAlign:"center"},{content:o.serverType,hAlign:"center"},{content:o.targetDir,hAlign:"center"},{content:o.deployDir,hAlign:"center"},{content:o.releaseDir,hAlign:"center"}])),console.log(t.toString())}import se from"chalk";async function P(){let e=a(),t=await ie.prompt([{type:"input",name:"name",message:"\u8BF7\u8F93\u5165\u9879\u76EE\u540D\u79F0(Project name)",validate:function(r){return/^[a-zA-Z0-9]+$/.test(r)?!0:e.find(n=>n.name===r)?"\u9879\u76EE\u5DF2\u5B58\u5728(project already exists)":"\u8BF7\u8F93\u5165\u82F1\u6587\u5B57\u7B26(enter English characters)"}},{type:"list",name:"type",message:"\u8BF7\u9009\u62E9\u670D\u52A1\u5668\u7C7B\u578B(Server type)",choices:["ssh","ftp"]},{type:"input",name:"host",message:"\u8BF7\u8F93\u5165\u670D\u52A1\u5668\u5730\u5740(Server address)",validate(r,n){return r?!0:"\u8BF7\u8F93\u5165\u670D\u52A1\u5668\u5730\u5740"}},{type:"input",name:"port",message:"\u8BF7\u8F93\u5165\u670D\u52A1\u5668\u7AEF\u53E3(SSH\u9ED8\u8BA422,FTP\u9ED8\u8BA421)(Server Port default is 21|22)",default:function(r){return r.type=="ssh"?22:21}},{type:"input",name:"username",message:"\u8BF7\u8F93\u5165\u670D\u52A1\u5668\u7528\u6237\u540D(\u9ED8\u8BA4root)(User name default is root)"},{type:"password",name:"password",message:"\u8BF7\u8F93\u5165\u670D\u52A1\u5668\u5BC6\u7801(Server Password)",mask:"*",validate(r,n){return r?!0:"\u8BF7\u8F93\u5165\u670D\u52A1\u5668\u5BC6\u7801"}},{type:"input",name:"targetDir",message:"\u672C\u5730\u9879\u76EE\u6587\u4EF6\u5939(\u4F8B:C:\\project)(The folder where the package file is located)",validate(r,n){return r?!0:"\u672C\u5730\u9879\u76EE\u6253\u5305\u6587\u4EF6\u5939(The folder where the package file is located)"},filter(r,n){return r.replace(/\\/g,"/")}},{type:"input",name:"deployDir",message:"\u8FDC\u7A0B\u90E8\u7F72\u76EE\u5F55(\u4F8B:/home/www/)(The deployment directory on the server)",validate(r,n){return r?!0:"\u8FDC\u7A0B\u90E8\u7F72\u76EE\u5F55(\u4F8B:/home/www/)(The deployment directory on the server)"},filter(r,n){return r.replace(/\\/g,"/")}},{type:"input",name:"releaseDir",message:"\u8FDC\u7A0B\u90E8\u7F72\u6587\u4EF6\u5939(The folder where the deployment package is located)"}]),o={value:t.name,server:{host:t.host,password:t.password,username:t.username||"root",port:t.port?Number(t.port):22},serverType:t.type,releaseDir:t.releaseDir||t.name,name:t.name,targetDir:t.targetDir,deployDir:t.deployDir};e.push(o),p(e),console.log(se.green("\u6DFB\u52A0\u6210\u529F")),d([o])}import ae from"inquirer";import le from"chalk";async function x(e){let t=a();if(t.find(r=>r.name===e))d([t.find(r=>r.name===e)]);else{console.log(le.red(`scd \u{1F975} ${e}\u914D\u7F6E\u4E0D\u5B58\u5728`));return}if((await ae.prompt({type:"confirm",name:"confirm",message:`\u662F\u5426\u786E\u8BA4\u5220\u9664 ${e} ?`})).confirm){let r=t.splice(t.findIndex(n=>n.name===e),1);p(t),console.log(`\u5DF2\u5220\u9664 ${e} `)}}import T from"chalk";var U=()=>{let e=a();e.length||(console.log(T.red("scd \u{1F9D0} \u65E0\u914D\u7F6E\u9879,\u8BF7\u8FD0\u884Cscd add\u53BB\u6DFB\u52A0\u4E00\u4E2A\u5427")),process.exit(0)),d(e)},L=e=>{let t=a();t.length||(console.log(T.red("scd \u{1F9D0} \u65E0\u914D\u7F6E\u9879,\u8BF7\u8FD0\u884Cscd add\u53BB\u6DFB\u52A0\u4E00\u4E2A\u5427")),process.exit(1));let o=t.filter(r=>r.name===e);console.log(o),o.length?d(o):console.log(T.red(`scd \u{1F975} ${e}\u914D\u7F6E\u4E0D\u5B58\u5728`))};import K from"chalk";import{exec as ce}from"child_process";function y(e,t){return new Promise((o,r)=>{ce(t,{cwd:e}).on("exit",o).on("error",r)})}import F from"node:path";import v from"chalk";import pe from"archiver";import me from"node:fs";import R from"node:path";import w from"chalk";function Z(e,t){return console.log(w.blue("ZIP \u23F3 \u6B63\u5728\u538B\u7F29\u6587\u4EF6...")),new Promise((o,r)=>{let n=me.createWriteStream(R.resolve(e,"dist.zip")),l=pe("zip",{zlib:{level:9}});l.pipe(n),l.directory(R.resolve(e,"dist"),t),l.finalize(),n.on("close",()=>{w.green("ZIP \u538B\u7F29\u5B8C\u6210"),w.green(console.log(`${w.green("SAVE \u{1F4BE} "+(l.pointer()/1024/1024).toFixed(2)+"MB")}\u5B57\u8282\u7684\u6570\u636E\u5DF2\u88AB\u5199\u5165\uFF1A${w.blue(e)}`)),o()}),n.on("error",r)})}import g from"chalk";import{NodeSSH as de}from"node-ssh";var u=new de;function fe(e){return new Promise(async(t,o)=>{u.connect(e.ssh).then(r=>{console.log(g.green(`${e.name} \u{1F605} \u670D\u52A1\u5668\u8FDE\u63A5\u6210\u529F`)),t(r)}).catch(r=>{console.log(g.red(`${e.name} \u{1F605} \u670D\u52A1\u5668\u8FDE\u63A5\u5931\u8D25`)),process.exit(0)})})}function ge(e){return new Promise((t,o)=>{u.execCommand(`ls ${e}`).then(r=>{r.stderr?t(!0):t(!1)}).catch(r=>{console.log(g.red("SSH \u{1F605} \u670D\u52A1\u5668\u8FDE\u63A5\u4E2D\u65AD"))})})}function ue(e){return new Promise((t,o)=>{u.execCommand(`rm -rf ${e}`).then(r=>{r.stderr?(t(r.stderr),process.exit(0)):t(!0)})})}function he(e,t){return new Promise((o,r)=>{u.putFile(e,t+"/dist.zip").then(n=>{console.log(g.green("SSH \u{1F4C2} \u6587\u4EF6\u4E0A\u4F20\u6210\u529F")),o(!0)}).catch(n=>{console.log(g.red("SSH \u{1F975} \u6587\u4EF6\u4E0A\u4F20\u5931\u8D25")),r(!1)})})}function ye(e,t){return new Promise((o,r)=>{u.execCommand("unzip dist.zip",{cwd:e}).then(n=>{console.log(g.green("SSH \u{1F4C2} \u6587\u4EF6\u89E3\u538B\u6210\u529F")),o(!0)}).catch(n=>{console.log(g.red("SSH \u{1F605} \u670D\u52A1\u5668\u8FDE\u63A5\u4E2D\u65AD")),r(!1)})})}var c={connect:fe,ssh:u,checkFile:ge,deleteFile:ue,putFile:he,unZip:ye};import we from"node:fs";async function z(e){try{console.log(v.blue(`${e.name} \u23F3 \u5F00\u59CB\u6253\u5305`)),await y(F.resolve(e.targetDir),"npm run build"),console.log(v.green(`${e.name} \u2714 \u6253\u5305\u5B8C\u6210`))}catch{console.log(v.red(`${e.name} \u2718 \u6253\u5305\u5931\u8D25`))}await Z(e.targetDir,e.releaseDir),await c.connect(e),await c.checkFile(e.deployDir+"/dist.zip")||await c.deleteFile(e.deployDir+"/dist"),await c.putFile(F.resolve(e.targetDir,"./dist.zip"),e.deployDir);let o=await c.checkFile(e.deployDir+e.releaseDir);await c.deleteFile(e.deployDir+e.releaseDir),await c.unZip(e.deployDir,e.releaseDir)&&console.log(v.green(`${e.name} \u2728 \u90E8\u7F72\u5B8C\u6210`)),await we.unlinkSync(F.resolve(e.targetDir,"./dist.zip")),await c.deleteFile(e.deployDir+"dist.zip")&&console.log(v.green(`${e.name} \u2728 \u4E34\u65F6\u6587\u4EF6\u6E05\u9664\u6210\u529F`)),c.ssh.dispose()}import*as _ from"basic-ftp";import f from"chalk";import C from"node:path";import q from"node:fs";import*as k from"cli-progress";function J(e){let t=0,o=q.readdirSync(e);for(let r of o){let n=C.join(e,r),l=q.statSync(n);l.isFile()?t+=l.size:l.isDirectory()&&(t+=J(n))}return t}var D,h=new _.Client,B=0,W=0,H=new k.SingleBar({format:"\u6B63\u5728\u4E0A\u4F20 |"+f.cyan("{bar}")+"| {percentage}% || {value}MB/{total}MB",barCompleteChar:"\u2588",barIncompleteChar:"\u2591",hideCursor:!0},k.Presets.shades_classic);h.trackProgress(e=>{e.name||(B=e.bytesOverall),H.update(Number(((e.bytesOverall-B)/1024/1024).toFixed(2)),{})});async function N(e){D=e;try{console.log(f.blue(`${e.name} \u23F3 \u5F00\u59CB\u6253\u5305`)),await y(C.resolve(e.targetDir),"npm run build"),console.log(f.green(`${e.name} \u2714 \u6253\u5305\u5B8C\u6210`)),W=J(C.resolve(D.targetDir,"./dist")),H.start(Number((W/1024/1024).toFixed(2)),0)}catch{console.log(f.red(`${e.name} \u2718 \u6253\u5305\u5931\u8D25`))}try{await h.access({host:e.server.host,user:e.server.username,password:e.server.password,port:e.server.port})}catch{console.log(f.red(`${e.name} \u{1F605} \u670D\u52A1\u5668\u8FDE\u63A5\u5931\u8D25`)),process.exit(0)}try{await h.ensureDir(`${D.deployDir}${D.releaseDir}`),await h.clearWorkingDir(),await h.uploadFromDir(C.resolve(D.targetDir,"./dist")),H.stop(),console.log(f.green(`${e.name} \u{1F389} \u4E0A\u4F20\u6210\u529F`)),console.log(f.green(`${e.name} \u2728 \u90E8\u7F72\u5B8C\u6210`)),h.close()}catch(t){console.log(f.red(`${e.name} \u{1F605} \u4E0A\u4F20\u5931\u8D25\u8BF7\u68C0\u67E5FTP\u914D\u7F6E\u6216\u67E5\u770B\u7F51\u7EDC\u8FDE\u63A5`,t))}}async function O(e){switch(e.serverType){case"ssh":z(e);break;case"ftp":await N(e);break}}import ve from"inquirer";import De from"chalk";async function S(e){let t=a();t.length||(console.log(De.red("scd \u{1F9D0} \u65E0\u914D\u7F6E\u9879,\u8BF7\u8FD0\u884Cscd add\u53BB\u6DFB\u52A0\u4E00\u4E2A\u5427")),process.exit(0));let o=t.map(r=>r.name);return ve.prompt([{type:"list",name:"projectName",message:"\u8BF7\u9009\u62E9\u8981\u64CD\u4F5C\u7684\u9879\u76EE",choices:o,default:1}])}import M from"chalk";import Se from"inquirer";async function $(e,t){let o=a();o.length||(console.log(M.red("scd \u{1F937}\u200D\u2642\uFE0F \u65E0\u914D\u7F6E\u9879,\u8BF7\u8FD0\u884Cscd add\u53BB\u6DFB\u52A0\u4E00\u4E2A\u5427")),process.exit(0));let r=a().findIndex(s=>s.name===e);r<0&&(console.log(M.red(`scd \u{1F975} ${e}\u914D\u7F6E\u4E0D\u5B58\u5728`)),process.exit(0));let n=await Se.prompt([{type:"input",name:"name",message:"\u8BF7\u8F93\u5165\u9879\u76EE\u540D\u79F0(Project name)",default:o[r].name,validate:function(s){return/^[a-zA-Z0-9]+$/.test(s)?!0:o.find(i=>i.name===s)?"\u9879\u76EE\u5DF2\u5B58\u5728(project already exists)":"\u8BF7\u8F93\u5165\u82F1\u6587\u5B57\u7B26(enter English characters)"}},{type:"list",name:"type",message:"\u8BF7\u9009\u62E9\u670D\u52A1\u5668\u7C7B\u578B(Server type)",choices:["ssh","ftp"]},{type:"input",name:"host",message:"\u8BF7\u8F93\u5165SSH\u5730\u5740(SSH address)",default:o[r].server.host,validate(s,i){return s?!0:"\u8BF7\u8F93\u5165SSH\u5730\u5740"}},{type:"input",name:"port",message:"\u8BF7\u8F93\u5165SSH\u7AEF\u53E3(\u9ED8\u8BA422)(SSH Port default is 22)",default:o[r].server.port},{type:"input",name:"username",message:"\u8BF7\u8F93\u5165\u670D\u52A1\u5668\u7528\u6237\u540D(\u9ED8\u8BA4root)(User name default is root)",default:o[r].server.username},{type:"password",name:"password",message:"\u8BF7\u8F93\u5165\u670D\u52A1\u5668\u5BC6\u7801(SSH Password)",default:o[r].server.password,validate(s,i){return s?!0:"\u8BF7\u8F93\u5165\u670D\u52A1\u5668\u5BC6\u7801"}},{type:"input",name:"targetDir",message:"\u672C\u5730\u9879\u76EE\u6253\u5305\u6587\u4EF6\u5939(\u4F8B:C:\\project\\dist)(The folder where the package file is located)",validate(s,i){return s?!0:"\u672C\u5730\u9879\u76EE\u6253\u5305\u6587\u4EF6\u5939(The folder where the package file is located)"},default:o[r].targetDir,filter(s,i){return s.replace(/\\/g,"/")}},{type:"input",name:"deployDir",message:"\u8FDC\u7A0B\u90E8\u7F72\u76EE\u5F55(\u4F8B:/home/www/)(The deployment directory on the server)",validate(s,i){return s?!0:"\u8FDC\u7A0B\u90E8\u7F72\u76EE\u5F55(\u4F8B:/home/www/)(The deployment directory on the server)"},filter(s,i){return s.replace(/\\/g,"/")},default:o[r].deployDir},{type:"input",name:"releaseDir",default:o[r].releaseDir,message:"\u8FDC\u7A0B\u90E8\u7F72\u6587\u4EF6\u5939(The folder where the deployment package is located)"}]),l={value:n.name,server:{host:n.host,password:n.password,username:n.username||"root",port:n.port?Number(n.port):22},serverType:n.type,releaseDir:n.releaseDir||n.name,name:n.name,targetDir:n.targetDir,deployDir:n.deployDir};o[r]=l,p(o)}import b from"chalk";function A(e,t="",o={}){for(let r in e)if(e.hasOwnProperty(r)){let n=t?t+"_"+r:r;typeof e[r]=="object"&&e[r]!==null?A(e[r],n,o):o[n]=e[r]}return o}import xe from"inquirer";var Ce={name:"\u8BF7\u8F93\u5165\u9879\u76EE\u540D\u79F0(Project name)",targetDir:"\u672C\u5730\u9879\u76EE\u6253\u5305\u6587\u4EF6\u5939(\u4F8B:C:\\project\\dist)(The folder where the package file is located)",deployDir:"\u8FDC\u7A0B\u90E8\u7F72\u76EE\u5F55(\u4F8B:/home/www/)(The deployment directory on the server)",releaseDir:"\u8FDC\u7A0B\u90E8\u7F72\u6587\u4EF6\u5939(The folder where the deployment package is located)",prot:"\u8BF7\u8F93\u5165\u670D\u52A1\u5668\u7AEF\u53E3(\u9ED8\u8BA422)(Server Port default is 22)",username:"\u8BF7\u8F93\u5165\u670D\u52A1\u5668\u7528\u6237\u540D(\u9ED8\u8BA4root)(User name default is root)",password:"\u8BF7\u8F93\u5165\u670D\u52A1\u5668\u5BC6\u7801(Server Password)",serverType:"\u670D\u52A1\u5668\u7C7B\u578B(Server type)",host:"\u670D\u52A1\u5668\u5730\u5740(Server host)"};async function E(e,t){let o=a(),r=a().findIndex(n=>n.name===e);if(r<0)console.log(b.red(`scd \u{1F975} ${e}\u914D\u7F6E\u4E0D\u5B58\u5728`)),process.exit(0);else{let n=A(o[r]),l=Object.keys(n),s=l.findIndex(G=>G.split("_").includes(t));s<0&&(console.log(b.red(`scd \u{1F975} ${t}\u914D\u7F6E\u4E0D\u5B58\u5728`)),process.exit(0));let i=l[s].split("_"),V=i[i.length-1],I=await xe.prompt([{type:i[i.length-1]=="password"?"password":i[i.length-1]=="serverType"?"list":"input",choices:["ssh","ftp"],name:i[i.length-1],message:Ce[V],default:i.length>1?o[r][i[0]][i[1]]:o[r][i[0]]}]);i.length>1?o[r][i[0]][i[1]]=I[i[1]]:o[r][i[0]]=I[i[0]],p(o)}}import{readFile as ke}from"fs/promises";var $e=JSON.parse(await ke(new URL("../package.json",import.meta.url)));m.version($e.version);m.command("add").action(async()=>{await P()}).description("\u6DFB\u52A0\u4E00\u4E2A\u9879\u76EE").alias("a");m.command("remove [name]").action(async e=>{if(e)await x(e);else{let t=await S(e);await x(t.projectName)}}).description("\u5220\u9664\u4E00\u4E2A\u9879\u76EE").alias("rm");m.command("list [name]").action(async e=>{e?(console.log(e,"listOnly"),await L(e)):await U()}).description("\u67E5\u770B\u4E00\u4E2A\u6216\u6240\u6709\u9879\u76EE").alias("ls");m.command("run [name]").action(async e=>{e||(e=(await S(e)).projectName);let t=a();t.length||(console.log(K.red("scd \u{1F9D0} \u65E0\u914D\u7F6E\u9879,\u8BF7\u8FD0\u884Cscd add\u53BB\u6DFB\u52A0\u4E00\u4E2A\u5427")),process.exit(0));let o=t.find(r=>r.name===e);o?await O(o):(console.log(K.red(`scd \u{1F975} ${e}\u914D\u7F6E\u4E0D\u5B58\u5728`)),process.exit(0))}).description("\u8FD0\u884C\u9879\u76EE\u6216\u6307\u5B9A\u4E00\u4E2A\u9879\u76EE").alias("r");m.command("edit [name] [key]").action(async(e,t)=>{!t&&!e&&(e=(await S(e)).projectName,await $(e),process.exit(0)),t&&e?await E(e,t):await $(e,t)}).description("\u7F16\u8F91\u4E00\u4E2A\u9879\u76EE\u6216\u9879\u76EE\u914D\u7F6E").alias("e");m.command("help").action(()=>{m.outputHelp()}).description("\u67E5\u770B\u5E2E\u52A9").alias("h");m.parse(process.argv);
